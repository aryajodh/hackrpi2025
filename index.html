<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.R.R.A.M. Advisor Bot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind and Custom Colors for Retro Theme -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on 'dark' class
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['"Courier New"', 'monospace'],
                    },
                    colors: {
                        'crt-green': '#00ff00',
                        'crt-dark': '#001a00',
                        'crt-yellow': '#ffcc00',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Courier New', monospace; }
        .crt {
            /* Basic CRT scanline effect */
            background: repeating-linear-gradient(
                to bottom,
                transparent 0,
                transparent 1px,
                rgba(0, 0, 0, 0.1) 1px,
                rgba(0, 0, 0, 0.2) 2px
            );
            /* Dark mode specific scanlines */
            .dark & {
                background: repeating-linear-gradient(
                    to bottom,
                    transparent 0,
                    transparent 1px,
                    rgba(0, 255, 0, 0.05) 1px,
                    rgba(0, 255, 0, 0.1) 2px
                );
            }
        }
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { border-right-color: transparent }
            50% { border-right-color: currentColor }
        }
        /* Style for the input cursor glow */
        input:focus {
            box-shadow: 0 0 5px currentColor;
        }
    </style>
</head>
<body class="transition-colors duration-500">
    <div id="root"></div>

    <!-- 1. Load React and ReactDOM (Must be first) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 2. Load Babel (Needed to compile JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Load Firebase Modules (EXPOSED GLOBALLY) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for the Babel script block to access
        window.FirebaseServices = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, setDoc, serverTimestamp, setLogLevel 
        };
        
        // Ensure global config variables are set, even if they're empty strings
        if (typeof window.__app_id === 'undefined') window.__app_id = 'default-app-id';
        if (typeof window.__firebase_config === 'undefined') window.__firebase_config = '{}';
        if (typeof window.__initial_auth_token === 'undefined') window.__initial_auth_token = null;

        console.log("Firebase services loaded and exposed globally.");
        window.isFirebaseSdkLoaded = true;
    </script>
    
    <!-- 4. Load the Application Logic (JSX) -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Inline SVG Icons (Replacing lucide-react) ---
        const Icon = ({ children, className }) => (
            <svg className={`w-5 h-5 ${className}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                {children}
            </svg>
        );
        const BotIcon = (props) => (
            <Icon {...props}>
                <path d="M12 18s-4 0-4-4 4-8 4-8 4 4 4 8-4 4-4 4zM12 2v2M4.22 8.22l1.42 1.42M19.78 8.22l-1.42 1.42M2 12h2M20 12h-2M6.41 17.59l1.42-1.42M17.59 17.59l-1.42-1.42"/>
            </Icon>
        );
        const SearchIcon = (props) => (
            <Icon {...props}>
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </Icon>
        );
        const SaveIcon = (props) => (
            <Icon {...props}>
                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </Icon>
        );
        const LoaderIcon = (props) => (
            <Icon {...props}>
                <path d="M21.5 2C17 2 13 4 12 7M2.5 22C7 22 11 20 12 17M12 22v-3M12 2v3"/>
            </Icon>
        );
        const XIcon = (props) => (
            <Icon {...props}>
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </Icon>
        );
        const MoonIcon = (props) => (
            <Icon {...props}>
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
            </Icon>
        );
        const SunIcon = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </Icon>
        );


        // --- Global Variables (Read from window) ---
        const appId = window.__app_id || 'default-trram-planner';
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const initialAuthToken = window.__initial_auth_token || null;
        const FirebaseServices = window.FirebaseServices || {};
        const API_KEY = ""; // Placeholder for the Gemini API Key

        // Destructure Firebase functions
        const { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, setDoc, serverTimestamp, setLogLevel
        } = FirebaseServices;
        
        // Flag to check if Firebase functions are available
        const isSDKLoaded = !!initializeApp && !!getAuth && !!getFirestore;


        // --- Course Data Structure for AI Output (JSON Schema) ---
        const COURSE_PLAN_SCHEMA = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "semester": { "type": "STRING", "description": "e.g., Fall 1, Spring 2, Summer Arch" },
                    "year": { "type": "INTEGER", "description": "Academic year number (1-4)" },
                    "courses": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "code": { "type": "STRING", "description": "Course code, e.g., CSCI 1100" },
                                "title": { "type": "STRING", "description": "Course full title" },
                                "credits": { "type": "INTEGER" },
                                "isCore": { "type": "BOOLEAN", "description": "True if mandatory core/major requirement" },
                                "isComplete": { "type": "BOOLEAN", "description": "False initially, toggled by user" }
                            },
                            required: ["code", "title", "credits", "isCore", "isComplete"]
                        }
                    }
                },
                required: ["semester", "year", "courses"]
            }
        };

        // --- System Instruction for Gemini ---
        const SYSTEM_INSTRUCTION = `
        You are a highly specialized RPI Academic Advisor Bot, T.R.R.A.M. (The Retro Registration Autonomous Machine). Your task is to generate a comprehensive, 4-year (8-semester) course plan for a student based on their declared major(s).

        Constraint: Every plan must adhere to the RPI "Arch" requirement: Year 2 ends with a mandatory Summer term ("Summer Arch"), and the following Fall or Spring term ("Year 3") must be an "Away" semester (empty courses).

        RPI Core Requirements to Incorporate (Assume Engineering/Science default):
        1.  **Total Credits:** Target 128 credits total (4-credit courses are typical).
        2.  **Semester Load:** Target 16 credits (4 courses) per Fall/Spring semester.
        3.  **HASS Core:** Must include: 1 HASS Inquiry (INQR), 1 HASS Communication Intensive (CI), 1 HASS 4000-level course, and a 12-credit Integrative Pathway.
        4.  **Science Core:** Includes core Math (Calc I/II, Diff Eq, etc.) and Physics I/II.

        Create a sequential, logical plan, ensuring prerequisites are met (e.g., Calc I before Calc II, CS I before Data Structures). You must ONLY return the JSON object following the provided schema. DO NOT include any explanatory text, markdown formatting, or notes outside the JSON block.
        `;

        // --- Utility Components for Retro Styling ---

        /** Custom Hook for Dark Mode */
        const useDarkMode = () => {
            const [isDarkMode, setIsDarkMode] = useState(false);

            useEffect(() => {
                const html = document.documentElement;
                const savedTheme = localStorage.getItem('trram-theme');
                
                if (savedTheme === 'dark') {
                    setIsDarkMode(true);
                    html.classList.add('dark');
                } else {
                    setIsDarkMode(false);
                    html.classList.remove('dark');
                }
            }, []);

            const toggleDarkMode = useCallback(() => {
                const html = document.documentElement;
                setIsDarkMode(prev => {
                    const newMode = !prev;
                    if (newMode) {
                        html.classList.add('dark');
                        localStorage.setItem('trram-theme', 'dark');
                    } else {
                        html.classList.remove('dark');
                        localStorage.setItem('trram-theme', 'light');
                    }
                    return newMode;
                });
            }, []);

            return [isDarkMode, toggleDarkMode];
        };

        /** Applies the CRT Terminal style to the entire app. */
        const TerminalWrapper = ({ children, isDarkMode, toggleDarkMode, userId, isEnvReady }) => (
            <div className={`min-h-screen p-4 sm:p-8 flex flex-col items-center w-full transition-colors duration-500
                ${isDarkMode 
                    ? 'bg-[#000000] text-crt-green' 
                    : 'bg-gray-100 text-gray-900'
                }`}
            >
                {/* Screen Container with Retro Look */}
                <div className={`w-full max-w-6xl p-4 sm:p-6 md:p-8 relative z-10 font-mono 
                    ${isDarkMode
                        ? 'border-4 border-crt-green shadow-[0_0_20px_#00ff00,inset_0_0_10px_#00ff00] bg-crt-dark'
                        : 'border-4 border-gray-900 shadow-xl bg-white'
                    } rounded-none overflow-hidden
                `}>
                    <header className={`mb-6 border-b-4 pb-3 flex justify-between items-start 
                        ${isDarkMode ? 'border-crt-yellow' : 'border-gray-900'}`
                    }>
                        <div>
                            <h1 className={`text-2xl sm:text-3xl font-bold uppercase cursor-blink flex items-center`}>
                                <BotIcon className={`w-6 h-6 mr-2 mb-1 ${isDarkMode ? 'text-crt-yellow' : 'text-indigo-600'}`} />
                                T.R.R.A.M. Bot 
                            </h1>
                            <p className={`text-sm ml-8 italic ${isDarkMode ? 'text-crt-yellow' : 'text-indigo-600'}`}>
                                Autonomous Advisor System Activated
                            </p>
                        </div>
                        <div className="flex flex-col items-end">
                            <button 
                                onClick={toggleDarkMode}
                                className={`p-2 border-2 text-sm transition-colors 
                                ${isDarkMode 
                                    ? 'border-crt-green bg-[#004400] text-crt-green hover:bg-[#006600]' 
                                    : 'border-gray-900 bg-gray-300 text-gray-900 hover:bg-gray-400'
                                }
                                `}
                                title="Toggle Theme"
                            >
                                {isDarkMode ? <SunIcon className="w-5 h-5" /> : <MoonIcon className="w-5 h-5" />}
                            </button>
                            <p className={`mt-2 text-xs ${isDarkMode ? 'text-[#008800]' : 'text-gray-600'}`}>User ID: {userId ? userId.substring(0, 8) + '...' : (isEnvReady ? 'Anon' : 'Loading')}</p>
                        </div>
                    </header>

                    <div className="crt text-sm sm:text-base">
                        {children}
                    </div>
                </div>
            </div>
        );

        /** Generic button with retro styling */
        const TerminalButton = ({ children, onClick, disabled, icon: Icon, className = '', isDarkMode }) => (
            <button
                onClick={onClick}
                disabled={disabled}
                className={`flex items-center justify-center space-x-2 px-3 py-2 border-2 font-bold uppercase disabled:opacity-50 disabled:cursor-not-allowed transition duration-150 rounded-none
                ${isDarkMode 
                    ? 'border-crt-green bg-[#004400] text-crt-green shadow-[2px_2px_0_#00ff00] hover:bg-[#006600] hover:shadow-[3px_3px_0_#00ff00]' 
                    : 'border-gray-900 bg-indigo-500 text-white shadow-[2px_2px_0_#333] hover:bg-indigo-600 hover:shadow-[3px_3px_0_#333]'
                }
                ${className}`}
            >
                {Icon && <Icon className="w-4 h-4" />}
                <span className="text-xs sm:text-sm">{children}</span>
            </button>
        );

        /** Display for a single course item */
        const CourseItem = ({ course, onToggle, isDarkMode }) => (
            <div
                className={`p-2 border-b flex justify-between items-center cursor-pointer transition duration-100 rounded-none
                ${isDarkMode ? 'border-[#004400]' : 'border-gray-200'}
                ${course.isComplete
                    ? `opacity-50 line-through ${isDarkMode ? 'text-[#008800]' : 'text-gray-500'}`
                    : `${isDarkMode ? 'text-crt-green hover:bg-[#002a00]' : 'text-gray-900 hover:bg-gray-100'}`
                }`}
                onClick={() => onToggle(course)}
                title="Click to toggle completion status (Completed/Needed)"
            >
                <span className="font-bold w-1/4 truncate">{course.code}</span>
                <span className="w-1/2 truncate">{course.title}</span>
                <span className="w-1/4 text-right font-bold text-sm">
                    {course.credits} cr.
                    {course.isCore && 
                        <span 
                            className={`ml-2 text-xs px-1 py-0 border rounded-none 
                                ${isDarkMode ? 'text-crt-yellow border-crt-yellow' : 'text-red-600 border-red-600'}
                            `}
                        >
                            CORE
                        </span>
                    }
                </span>
            </div>
        );


        // --- Main Application Component ---
        const App = () => {
            const [programs, setPrograms] = useState('');
            const [plan, setPlan] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [authReady, setAuthReady] = useState(false);
            const [isDarkMode, toggleDarkMode] = useDarkMode();
            const documentId = 'default-plan'; 

            // --- Firebase Initialization and Authentication ---
            useEffect(() => {
                // Only attempt initialization if the SDK is confirmed loaded
                if (!isSDKLoaded) {
                    setError("System Alert: Waiting for Firebase SDK to load...");
                    return;
                }
                if (authReady) return; // Already initialized

                try {
                    setLogLevel('debug');
                    
                    // Critical check: Ensure config is not an empty object if we expect it
                    if (Object.keys(firebaseConfig).length === 0) {
                        console.warn("Firebase Config is empty. Proceeding with anonymous sign-in.");
                    }

                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    setDb(dbInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            console.log("Auth State: Signed in. User ID:", user.uid);
                        } else {
                            // If the initial token is present, try custom sign-in
                            if (initialAuthToken) {
                                try {
                                    const userCredential = await signInWithCustomToken(authInstance, initialAuthToken);
                                    setUserId(userCredential.user.uid);
                                } catch (err) {
                                    console.warn("Custom Token Sign-In Failed:", err.message);
                                    const userCredential = await signInAnonymously(authInstance);
                                    setUserId(userCredential.user.uid);
                                }
                            } else {
                                // Fallback to anonymous sign-in
                                const userCredential = await signInAnonymously(authInstance);
                                setUserId(userCredential.user.uid);
                            }
                        }
                        setAuthReady(true); 
                        setError(null); // Clear any pending SDK load errors
                    });

                    return () => unsubscribe();
                } catch (err) {
                    console.error("Firebase Init Error:", err);
                    // This is the source of the user's observed error.
                    setError("System Error: Could not initialize Firebase services. Check console for details.");
                    setAuthReady(true);
                }
            }, [initialAuthToken, authReady]); // Dependencies include authReady to ensure we only run once

            // --- Firestore Path Helper ---
            const getPlanDocRef = useCallback(() => {
                if (!db || !userId || !doc) return null;
                // Private data path: /artifacts/{appId}/users/{userId}/course_plans/default-plan
                return doc(db, 'artifacts', appId, 'users', userId, 'course_plans', documentId);
            }, [db, userId, appId, documentId]);

            // --- Load Plan from Firestore (Real-time Listener) ---
            useEffect(() => {
                const docRef = getPlanDocRef();
                // Ensure authentication is complete and the doc reference is valid before attaching listener
                if (!authReady || !docRef || !onSnapshot) return;
                
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setPrograms(data.programs || '');
                        setPlan(data.plan || null);
                        console.log("Plan loaded from Firestore.");
                    } else {
                        console.log("No existing plan found in Firestore.");
                        setPlan(null); 
                    }
                }, (err) => {
                    console.error("Firestore onSnapshot error:", err);
                    // Only set error if it's not the initial 'waiting for auth' state
                    if (authReady) { 
                        setError("Error: Failed to load plan data.");
                    }
                });

                return () => unsubscribe();
            }, [authReady, getPlanDocRef]);

            // --- Save Plan to Firestore ---
            const savePlan = useCallback(async (currentPlan = plan) => {
                const docRef = getPlanDocRef();
                if (!docRef || !currentPlan || !setDoc || !serverTimestamp) {
                    setError("Error: Cannot save. Firebase connection missing or plan data is empty.");
                    return;
                }
                
                setLoading(true);
                setError(null);
                try {
                    await setDoc(docRef, {
                        programs: programs,
                        plan: currentPlan,
                        userId: userId,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    console.log("Plan saved successfully!");
                } catch (e) {
                    console.error("Error saving document: ", e);
                    setError("Error: Failed to save the plan. See console for permissions details.");
                } finally {
                    setLoading(false);
                }
            }, [getPlanDocRef, plan, programs, userId]);

            // --- Gemini API Call for Plan Generation ---
            const fetchPlan = async () => {
                if (!programs.trim()) {
                    setError("Please enter your RPI program(s) first (e.g., 'CS, Dual Math').");
                    return;
                }
                
                setLoading(true);
                setError(null);
                const userQuery = `Generate a 4-year, 8-semester course plan for a student entering RPI with the following program(s): ${programs.trim()}.`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: COURSE_PLAN_SCHEMA,
                    }
                };

                let attempts = 0;
                const maxAttempts = 5;
                let generatedPlan = null;
                let success = false;

                while (attempts < maxAttempts && !success) {
                    attempts++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (jsonText) {
                            generatedPlan = JSON.parse(jsonText);
                            success = true;
                        } else {
                            throw new Error("API returned no content.");
                        }
                    } catch (e) {
                        console.error(`Attempt ${attempts} failed.`, e); 
                        if (attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempts - 1)));
                        } else {
                            setError("Error: Failed to generate plan after multiple retries. Try simplifying your input.");
                        }
                    }
                }

                if (success && generatedPlan) {
                    setPlan(generatedPlan);
                    await savePlan(generatedPlan); // Save immediately after successful generation
                }
                setLoading(false);
            };
            
            // --- Plan Modification Logic: Toggle Course Status ---
            const toggleCourseCompletion = useCallback((courseToToggle) => {
                setPlan(prevPlan => {
                    if (!prevPlan) return prevPlan;

                    const updatedPlan = prevPlan.map(semester => ({
                        ...semester,
                        courses: semester.courses.map(course =>
                            (course.code === courseToToggle.code && semester.semester === courseToToggle.semester)
                                ? { ...course, isComplete: !course.isComplete }
                                : course
                        ),
                    }));
                    savePlan(updatedPlan); // Save the updated plan to Firestore immediately
                    return updatedPlan;
                });
            }, [savePlan]);

            // --- Credit Calculations ---
            const { totalCredits, completedCredits } = useMemo(() => {
                if (!plan) return { totalCredits: 0, completedCredits: 0 };
                
                const total = plan.reduce((sum, semester) => 
                    sum + semester.courses.reduce((semSum, course) => semSum + course.credits, 0)
                , 0);

                const completed = plan.reduce((sum, semester) => 
                    sum + semester.courses.reduce((semSum, course) => semSum + (course.isComplete ? course.credits : 0), 0)
                , 0);
                
                return { totalCredits: total, completedCredits: completed };
            }, [plan]);


            // --- Main Render ---
            const terminalAccent = isDarkMode ? 'text-crt-yellow' : 'text-indigo-600';
            const errorColor = isDarkMode ? 'border-[#ff0000] bg-[#440000] text-[#ff0000]' : 'border-red-600 bg-red-100 text-red-800';
            const infoColor = isDarkMode ? 'border-crt-green bg-[#004400]' : 'border-green-600 bg-green-100';

            // Check if environment is ready
            if (!isSDKLoaded) {
                return (
                    <TerminalWrapper isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} userId={null} isEnvReady={false}>
                        <div className={`w-full text-center p-12 border-2 border-dashed rounded-none mt-10 
                            ${isDarkMode ? 'border-crt-green text-crt-green' : 'border-gray-500 text-gray-600'}`}>
                            <LoaderIcon className={`w-10 h-10 mx-auto mb-4 animate-spin ${terminalAccent}`} />
                            <p className="text-lg uppercase">SYSTEM BOOTING... LOADING REQUIRED SDKS.</p>
                            <p className="text-sm mt-2">Please wait while the environment initializes.</p>
                        </div>
                    </TerminalWrapper>
                );
            }


            return (
                <TerminalWrapper isDarkMode={isDarkMode} toggleDarkMode={toggleDarkMode} userId={userId} isEnvReady={authReady}>
                    
                    {/* Input Section (Bot Command Line) */}
                    <div className="w-full mb-6">
                        <label htmlFor="programs" className={`block mb-2 text-sm uppercase ${terminalAccent}`}>
                            ADVISOR BOT READY: AWAITING COMMAND.
                        </label>
                        <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-2">
                            <input
                                id="programs"
                                type="text"
                                value={programs}
                                onChange={(e) => setPrograms(e.target.value)}
                                disabled={loading || !authReady}
                                className={`flex-grow p-2 border-2 focus:ring-0 focus:outline-none rounded-none font-mono
                                    ${isDarkMode 
                                        ? 'bg-[#111111] border-crt-green text-crt-green caret-crt-green placeholder-[#008800]' 
                                        : 'bg-white border-gray-900 text-gray-900 placeholder-gray-500'
                                    }
                                `}
                                placeholder="> Enter major(s) (e.g., Computer Science) and press RUN"
                            />
                            <TerminalButton onClick={fetchPlan} disabled={loading || !authReady} icon={SearchIcon} isDarkMode={isDarkMode}>
                                {loading ? 'EXECUTING...' : 'RUN PLAN'}
                            </TerminalButton>
                        </div>
                    </div>

                    {/* Status and Error Messages */}
                    {error && (
                        <div className={`w-full p-3 mb-4 border-2 rounded-none flex items-center space-x-2 ${errorColor}`}>
                            <XIcon className="w-5 h-5" />
                            <span className="font-bold">SYSTEM ALERT:</span> <span>{error}</span>
                        </div>
                    )}

                    {loading && (
                        <div className={`w-full p-3 mb-4 text-center border-2 rounded-none flex items-center justify-center space-x-2 animate-pulse ${infoColor} ${isDarkMode ? 'text-crt-green' : 'text-green-800'}`}>
                            <LoaderIcon className="w-5 h-5 animate-spin" />
                            <span className="uppercase">Processing Request... Querying Academic Database...</span>
                        </div>
                    )}
                    
                    {/* Plan Summary and Controls */}
                    {plan && (
                        <div className={`w-full mb-6 p-4 border-2 rounded-none ${isDarkMode ? 'border-crt-green bg-[#001a00]' : 'border-gray-900 bg-gray-50'}`}>
                            <h2 className={`text-xl uppercase font-bold mb-3 border-b pb-1 ${isDarkMode ? 'border-[#004400]' : 'border-gray-300'}`}>
                                T.R.R.A.M. OUTPUT: Program Plan for ({programs})
                            </h2>
                            <div className="flex justify-between text-sm mb-3">
                                <p>
                                    <span className={terminalAccent}>TOTAL CREDITS:</span> {totalCredits} / ~128
                                </p>
                                <p>
                                    <span className={terminalAccent}>COMPLETED CREDITS:</span> {completedCredits}
                                </p>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                <TerminalButton onClick={() => savePlan(plan)} disabled={loading || !authReady} icon={SaveIcon} isDarkMode={isDarkMode}>
                                    Save Progress
                                </TerminalButton>
                                <TerminalButton onClick={() => setPlan(null)} disabled={loading} icon={XIcon} className={isDarkMode ? 'bg-[#440000]' : 'bg-red-500'} isDarkMode={isDarkMode}>
                                    Clear Plan
                                </TerminalButton>
                                <TerminalButton onClick={fetchPlan} disabled={loading || !authReady} icon={() => <span className="text-xl">â†»</span>} isDarkMode={isDarkMode}>
                                    Regenerate Plan
                                </TerminalButton>
                            </div>
                        </div>
                    )}

                    {/* Schedule Display Grid */}
                    {plan ? (
                        <div className="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                            {plan.map((semester, index) => (
                                <div
                                    key={index}
                                    className={`border-2 p-3 rounded-none 
                                        ${semester.semester.includes('Away')
                                            ? `${isDarkMode ? 'border-dashed border-crt-yellow bg-[#1a001a]' : 'border-dashed border-yellow-600 bg-yellow-50'}`
                                            : `${isDarkMode ? 'border-crt-green bg-[#001a00]' : 'border-gray-900 bg-white'}`
                                        }`
                                    }
                                >
                                    <h3 className={`text-lg font-bold mb-2 uppercase text-center border-b pb-1 
                                        ${isDarkMode ? 'border-crt-green' : 'border-gray-700'}`
                                    }>
                                        {semester.semester} (Year {semester.year})
                                    </h3>
                                    
                                    {semester.courses.length === 0 ? (
                                        <p className={`italic text-center py-4 ${terminalAccent}`}>
                                            {semester.semester.includes('Away') ? 'ARCH AWAY SEMESTER' : 'FREE TERM'}
                                        </p>
                                    ) : (
                                        <>
                                            {semester.courses.map((course, courseIndex) => (
                                                <CourseItem 
                                                    key={courseIndex} 
                                                    course={{...course, semester: semester.semester}} 
                                                    onToggle={toggleCourseCompletion} 
                                                    isDarkMode={isDarkMode}
                                                />
                                            ))}
                                            <div className={`text-sm mt-2 pt-2 border-t text-right 
                                                ${isDarkMode ? 'border-[#004400] text-[#008800]' : 'border-gray-300 text-gray-600'}`}>
                                                Total: {semester.courses.reduce((sum, c) => sum + c.credits, 0)} Credits
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className={`w-full text-center p-12 border-2 border-dashed rounded-none mt-10 
                            ${isDarkMode ? 'border-crt-green text-crt-green' : 'border-gray-500 text-gray-600'}`}>
                            <BotIcon className={`w-10 h-10 mx-auto mb-4 animate-pulse ${terminalAccent}`} />
                            <p className="text-lg uppercase">INITIALIZED. T.R.R.A.M. AWAITS COMMANDS.</p>
                            <p className="text-sm mt-2">Enter your program(s) above and click 'Run Plan' to start course generation.</p>
                        </div>
                    )}
                </TerminalWrapper>
            );
        };

        // Render the main component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>